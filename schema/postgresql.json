{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://stratus.dev/schema/postgresql.json",
  "title": "Stratus PostgreSQL Schema Definition",
  "description": "JSON schema definition for PostgreSQL database schema with advanced features",
  "type": "object",
  "required": ["version", "tables"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Schema version identifier",
      "examples": ["1"]
    },
    "dialect": {
      "type": "string",
      "const": "postgresql",
      "description": "Database dialect (must be 'postgresql')"
    },
    "tables": {
      "type": "object",
      "description": "Database tables definition",
      "additionalProperties": {
        "$ref": "#/$defs/table"
      }
    },
    "enums": {
      "type": "object",
      "description": "Custom enum definitions",
      "additionalProperties": {
        "type": "array",
        "items": { "type": "string" },
        "minItems": 1
      }
    }
  },
  "$defs": {
    "table": {
      "type": "object",
      "required": ["columns"],
      "properties": {
        "columns": {
          "type": "object",
          "description": "Table columns",
          "additionalProperties": { "$ref": "#/$defs/column" }
        },
        "indexes": {
          "type": "array",
          "description": "Table indexes",
          "items": { "$ref": "#/$defs/index" }
        },
        "constraints": {
          "type": "array",
          "description": "Table-level constraints",
          "items": { "$ref": "#/$defs/tableConstraint" }
        },
        "options": {
          "$ref": "#/$defs/tableOptions",
          "description": "PostgreSQL table options"
        },
        "partitions": {
          "type": "array",
          "description": "Table partitions for partitioned tables",
          "items": { "$ref": "#/$defs/partition" }
        },
        "inherits": {
          "type": "array",
          "description": "Parent tables for table inheritance",
          "items": { "type": "string" }
        }
      }
    },
    "column": {
      "type": "object",
      "required": ["name", "type"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Column name in database"
        },
        "type": {
          "type": "string",
          "description": "PostgreSQL data type",
          "enum": [
            "serial", "bigserial", "smallserial",
            "integer", "int", "int4", "int8", "bigint", "smallint",
            "float", "double precision", "real", "decimal", "numeric",
            "varchar", "char", "bpchar", "text",
            "boolean", "bool",
            "date", "timestamp", "timestamptz", "timestamp with time zone", 
            "timestamp without time zone", "time", "timetz", 
            "time with time zone", "time without time zone", "interval",
            "json", "jsonb",
            "uuid", "xml", "bytea",
            "point", "line", "lseg", "box", "path", "polygon", "circle",
            "cidr", "inet", "macaddr", "macaddr8",
            "tsvector", "tsquery",
            "hstore", "ltree",
            "money",
            "pg_lsn", "pg_snapshot", "txid_snapshot",
            "bit", "varbit", "bit varying",
            "name", "oid", "xid", "cid", "tid",
            "any", "anyelement", "anyarray", "anynonarray", "anyenum", "anyrange",
            "unknown"
          ]
        },
        "size": {
          "type": "integer",
          "description": "Size/length for types like varchar(n)"
        },
        "scale": {
          "type": "integer",
          "description": "Decimal scale for numeric/decimal types"
        },
        "arrayDimensions": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of array dimensions"
        },
        "isPrimaryKey": {
          "type": "boolean",
          "description": "Primary key column",
          "default": false
        },
        "isNotNull": {
          "type": "boolean",
          "description": "NOT NULL constraint",
          "default": false
        },
        "isUnique": {
          "type": "boolean",
          "description": "UNIQUE constraint",
          "default": false
        },
        "default": {
          "type": "string",
          "description": "Default value expression",
          "examples": ["now()", "current_timestamp", "gen_random_uuid()", "true", "0"]
        },
        "identity": {
          "type": "object",
          "description": "IDENTITY column (SERIAL replacement)",
          "properties": {
            "always": {
              "type": "boolean",
              "description": "GENERATED ALWAYS vs GENERATED BY DEFAULT"
            },
            "sequence": {
              "type": "object",
              "description": "Sequence options",
              "properties": {
                "start": { "type": "integer" },
                "minvalue": { "type": "integer" },
                "maxvalue": { "type": "integer" },
                "increment": { "type": "integer" },
                "cycle": { "type": "boolean" }
              }
            }
          }
        },
        "generated": {
          "type": "object",
          "description": "Generated column (PostgreSQL 12+)",
          "properties": {
            "always": { "type": "boolean" },
            "expression": { "type": "string" }
          }
        },
        "collation": {
          "type": "string",
          "description": "Collation locale",
          "examples": ["en_US.utf8", "C", "POSIX"]
        },
        "storage": {
          "type": "string",
          "description": "TOAST storage type",
          "enum": ["plain", "external", "extended", "main"]
        },
        "statistics": {
          "type": "integer",
          "description": "Column statistics target (0-10000)",
          "minimum": 0,
          "maximum": 10000
        },
        "compression": {
          "type": "string",
          "description": "Compression method for toastable columns",
          "examples": ["pglz", "lz4"]
        },
        "references": {
          "type": "object",
          "description": "Foreign key reference",
          "required": ["table", "column"],
          "properties": {
            "table": { "type": "string" },
            "column": { "type": "string" },
            "onDelete": {
              "type": "string",
              "enum": ["cascade", "setNull", "setDefault", "restrict", "noAction"]
            },
            "onUpdate": {
              "type": "string",
              "enum": ["cascade", "setNull", "setDefault", "restrict", "noAction"]
            },
            "match": {
              "type": "string",
              "enum": ["full", "simple", "partial"]
            }
          }
        }
      }
    },
    "index": {
      "type": "object",
      "required": ["name", "columns"],
      "properties": {
        "name": { "type": "string", "description": "Index name" },
        "columns": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1
        },
        "unique": { "type": "boolean", "default": false },
        "ifNotExists": { "type": "boolean", "default": false },
        "method": {
          "type": "string",
          "description": "Index access method",
          "enum": ["btree", "hash", "gist", "spgist", "gin", "brin"]
        },
        "tablespace": { "type": "string", "description": "Tablespace name" },
        "with": {
          "type": "object",
          "description": "Index storage parameters",
          "properties": {
            "fillfactor": { "type": "integer", "minimum": 10, "maximum": 100 },
            "deduplicateItems": { "type": "boolean" },
            "fastupdate": { "type": "boolean" },
            "buffering": { "type": "string" },
            "pagesPerRange": { "type": "integer" }
          }
        },
        "where": {
          "type": "string",
          "description": "Partial index WHERE clause"
        },
        "nullsNotDistinct": {
          "type": "boolean",
          "description": "NULLS NOT DISTINCT (PostgreSQL 15+)"
        },
        "opclass": {
          "type": "object",
          "description": "Operator classes for index columns",
          "additionalProperties": { "type": "string" }
        }
      }
    },
    "tableConstraint": {
      "type": "object",
      "required": ["constraintType"],
      "properties": {
        "name": { "type": "string", "description": "Constraint name" },
        "constraintType": {
          "type": "string",
          "enum": ["primary key", "unique", "check", "exclude", "foreign key"]
        },
        "columns": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1
        },
        "expression": {
          "type": "string",
          "description": "CHECK constraint expression or EXCLUDE clause"
        },
        "references": {
          "type": "object",
          "required": ["table"],
          "properties": {
            "table": { "type": "string" },
            "column": { "type": "string" },
            "onDelete": {
              "type": "string",
              "enum": ["cascade", "setNull", "setDefault", "restrict", "noAction"]
            },
            "onUpdate": {
              "type": "string",
              "enum": ["cascade", "setNull", "setDefault", "restrict", "noAction"]
            },
            "match": { "type": "string", "enum": ["full", "simple", "partial"] }
          }
        },
        "deferrable": { "type": "boolean", "default": false },
        "initiallyDeferred": { "type": "boolean", "default": false }
      }
    },
    "tableOptions": {
      "type": "object",
      "description": "PostgreSQL table-level options",
      "properties": {
        "tablespace": { "type": "string", "description": "Tablespace name" },
        "fillfactor": { "type": "integer", "minimum": 10, "maximum": 100 },
        "toastTupleTarget": { "type": "integer" },
        "autovacuumEnabled": { "type": "boolean" },
        "parallelWorkers": { "type": "integer", "minimum": 0, "maximum": 1024 }
      }
    },
    "partition": {
      "type": "object",
      "required": ["name", "partitionType", "key"],
      "properties": {
        "name": { "type": "string", "description": "Partition name" },
        "partitionType": {
          "type": "string",
          "enum": ["range", "list", "hash"]
        },
        "key": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1
        },
        "rangeFrom": { "type": "array", "items": { "type": "string" } },
        "rangeTo": { "type": "array", "items": { "type": "string" } },
        "values": { "type": "array", "items": { "type": "string" } },
        "tablespace": { "type": "string" }
      }
    }
  }
}
